# ğŸ”— Next.js Serverless URL Shortener

ä¸€ä¸ªåŸºäº **Next.js 14+ (App Router)** å’Œ **Supabase** æ„å»ºçš„ç°ä»£åŒ–ã€é«˜æ€§èƒ½çŸ­é“¾æ¥ç”Ÿæˆä¸ç®¡ç†å¹³å°ã€‚æ”¯æŒ Serverless éƒ¨ç½²ï¼Œæ‹¥æœ‰ç”¨æˆ·è®¤è¯ã€åå°ç®¡ç†å’Œæ•°æ®ç»Ÿè®¡åŠŸèƒ½ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **æé€Ÿè·³è½¬**: åŸºäº Next.js Edge/Serverless æ¶æ„ã€‚
- ğŸ›¡ï¸ **ç”¨æˆ·è®¤è¯**: é›†æˆ Supabase Auth (é‚®ç®±/å¯†ç ç™»å½•)ã€‚
- ğŸ“Š **æ•°æ®ç»Ÿè®¡**: å®æ—¶è¿½è¸ªçŸ­é“¾ç‚¹å‡»æ¬¡æ•°ã€‚
- ğŸ¨ **ç°ä»£åŒ– UI**: ä½¿ç”¨ shadcn/ui + Tailwind CSSï¼Œæ”¯æŒè‡ªåŠ¨æ·±è‰²æ¨¡å¼ã€‚
- ğŸ“± **å“åº”å¼è®¾è®¡**: å®Œç¾é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ã€‚
- âš¡ **äº¤äº’åŠ¨ç”»**: ä¸æ»‘çš„ Framer Motion åˆ—è¡¨ä¸å¾®äº¤äº’ã€‚
- ğŸ”’ **æ•°æ®å®‰å…¨**: å®Œæ•´çš„ RLS (è¡Œçº§å®‰å…¨ç­–ç•¥) ä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: [Next.js 14/15 (App Router)](https://nextjs.org)
- **è¯­è¨€**: TypeScript
- **æ•°æ®åº“ & Auth**: [Supabase](https://supabase.com) (PostgreSQL)
- **æ ·å¼**: [Tailwind CSS](https://tailwindcss.com)
- **ç»„ä»¶åº“**: [shadcn/ui](https://ui.shadcn.com)
- **åŠ¨ç”»**: [Framer Motion](https://www.framer.com/motion/)
- **åŒ…ç®¡ç†**: pnpm

## ğŸš€ æœ¬åœ°å¼€å‘æŒ‡å—

### 1. å…‹éš†é¡¹ç›®
```bash
git clone git@github.com:kazukokawagawa/short-url-next.git
cd short-url-next
```

### 2. å®‰è£…ä¾èµ–
```bash
pnpm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶ <code>.env.example</code> ä¸º <code>.env.local</code>ï¼š

åœ¨ <code>.env.local</code> ä¸­å¡«å…¥ä½ çš„ Supabase é…ç½®ï¼š

```
NEXT_PUBLIC_SUPABASE_URL=ä½ çš„_Supabase_Project_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=ä½ çš„_Supabase_Anon_Key
NEXT_PUBLIC_BASE_URL=http://localhost:3000
SUPABASE_SERVICE_ROLE_KEY=ä½ çš„Secret keyï¼ˆä¹Ÿå« service_role keyï¼‰
```

### 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```
æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:3000ã€‚

## ğŸ—„ï¸æ•°æ®åº“é…ç½® (Supabase)

åœ¨ä½¿ç”¨å‰ï¼Œä½ éœ€è¦å» Supabase Dashboard çš„ SQL Editor è¿è¡Œä»¥ä¸‹ SQL è¯­å¥æ¥åˆå§‹åŒ–è¡¨ç»“æ„å’Œå‡½æ•°ã€‚

### 1. åˆå§‹åŒ–è¡¨ç»“æ„ä¸ RLS ç­–ç•¥

```SQL
-- åˆ›å»ºé“¾æ¥è¡¨
create table public.links (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  original_url text not null,
  slug text not null unique,
  clicks int default 0,
  user_id uuid references auth.users not null default auth.uid()
);

alter table public.links 
add column is_no_index boolean default true;

create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text,
  role text default 'user' check (role in ('user', 'admin'))
);

-- å‘ links è¡¨æ·»åŠ  user_email å­—æ®µ
ALTER TABLE links 
ADD COLUMN user_email text;

-- å¯é€‰ï¼šä¸ºæ–¹ä¾¿æŸ¥è¯¢ï¼Œç»™ user_email æ·»åŠ ç´¢å¼•
CREATE INDEX idx_links_user_email ON links(user_email);

-- å¼€å¯è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
alter table public.links enable row level security;

-- ç­–ç•¥ï¼šå…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„é“¾æ¥
create policy "User can view own links" 
on public.links for select 
using (auth.uid() = user_id);

-- ç­–ç•¥ï¼šå…è®¸ç”¨æˆ·åˆ›å»ºé“¾æ¥
create policy "User can create own links" 
on public.links for insert 
with check (auth.uid() = user_id);

-- ç­–ç•¥ï¼šå…è®¸ç”¨æˆ·åˆ é™¤è‡ªå·±çš„é“¾æ¥
create policy "User can delete own links" 
on public.links for delete 
using (auth.uid() = user_id);

create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text,
  role text default 'user' check (role in ('user', 'admin'))
);

alter table public.profiles enable row level security;

create or replace function public.is_admin()
returns boolean
language sql
security definer -- å…³é”®ï¼šä»¥å®šä¹‰è€…æƒé™è¿è¡Œï¼Œç»•è¿‡ RLS
set search_path = public -- å®‰å…¨æœ€ä½³å®è·µ
stable
as $$
  select exists (
    select 1
    from public.profiles
    where id = auth.uid()
    and role = 'admin'
  );
$$;

-- å…è®¸ç”¨æˆ·çœ‹è‡ªå·± (åŸºç¡€ç­–ç•¥)
create policy "Users can view own profile"
on public.profiles for select
to authenticated
using ( auth.uid() = id );

-- å…è®¸ç®¡ç†å‘˜çœ‹æ‰€æœ‰äºº
create policy "Admins can view all profiles"
on public.profiles for select
to authenticated
using ( is_admin() );

-- æŸ¥è¯¢
SELECT 
    au.email as "ç™»å½•é‚®ç®±",
    au.id as "ç™»å½•ID (Auth)",
    p.role as "å½“å‰è§’è‰²",
    p.id as "ä¸šåŠ¡è¡¨ID (Profile)"
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE au.email = 'ä½ çš„ç™»å½•é‚®ç®±@example.com';

-- åˆ›å»ºç³»ç»Ÿè®¾ç½®è¡¨ (ç®¡ç†å‘˜ä¸“ç”¨)
create table public.settings (
  id bigint generated by default as identity primary key,
  key text not null unique,
  value jsonb not null,
  description text,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- å¼€å¯ RLS
alter table public.settings enable row level security;

-- ç­–ç•¥ï¼š
-- å…è®¸æ‰€æœ‰äººï¼ˆåŒ…æ‹¬åŒ¿åç”¨æˆ·ï¼‰è¯»å– settings è¡¨
CREATE POLICY "Allow public read access to settings"
ON settings
FOR SELECT
USING (true);

-- ç­–ç•¥ï¼šä»…ç®¡ç†å‘˜å¯æ›´æ–°
create policy "Admins can update settings"
on public.settings for update
to authenticated
using ( is_admin() );

-- ç­–ç•¥ï¼šä»…ç®¡ç†å‘˜å¯æ’å…¥
create policy "Admins can insert settings"
on public.settings for insert
to authenticated
with check ( is_admin() );

-- åˆå§‹åŒ–é»˜è®¤è®¾ç½®
insert into public.settings (key, value, description) values
  ('site', '{"name": "LinkFlow", "subtitle": "ä¸‹ä¸€ä»£çŸ­é“¾æ¥ç”Ÿæˆå™¨", "description": "è®©é“¾æ¥æ›´çŸ­ï¼Œè®©åˆ†äº«æ›´ç®€å•", "keywords": "çŸ­é“¾æ¥,URL Shortener,Link Management,Next.js", "authorName": "æ± é±¼", "authorUrl": "https://chiyu.it", "allowPublicShorten": true}', 'ç«™ç‚¹é…ç½®'),
  ('links', '{"slugLength": 6, "enableClickStats": true}', 'é“¾æ¥è®¾ç½®'),
  ('appearance', '{"primaryColor": "#7c3aed", "themeMode": "system"}', 'å¤–è§‚è®¾ç½®'),
  ('data', '{"autoCleanExpired": false, "expiredDays": 90}', 'æ•°æ®ç®¡ç†'),
  ('maintenance', '{"enabled": false, "message": ""}', 'ç»´æŠ¤æ¨¡å¼');

  -- å…è®¸ user_id å’Œ user_email ä¸ºç©ºï¼ˆæ”¯æŒåŒ¿åç”¨æˆ·ï¼‰
ALTER TABLE links ALTER COLUMN user_id DROP NOT NULL;
ALTER TABLE links ALTER COLUMN user_email DROP NOT NULL;

```

### 2. åˆ›å»ºç‚¹å‡»è®¡æ•°å‡½æ•° (RPC)

ä¸ºäº†è®©æœªç™»å½•ç”¨æˆ·ï¼ˆè®¿å®¢ï¼‰ç‚¹å‡»çŸ­é“¾æ—¶ä¹Ÿèƒ½å¢åŠ è®¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç»•è¿‡ RLS çš„æ•°æ®åº“å‡½æ•°ã€‚

```SQL
create or replace function increment_clicks(slug_param text)
returns void
language plpgsql
security definer -- å…³é”®ï¼šä»¥å®šä¹‰è€…æƒé™è¿è¡Œ
as $$
begin
  update public.links
  set clicks = clicks + 1
  where slug = slug_param;
end;
$$;
```

### 3. é…ç½® Auth

åœ¨ Supabase åå° -> Authentication -> Providers -> Emailï¼š

- å»ºè®®å…³é—­ Confirm email (å¼€å‘é˜¶æ®µæ–¹ä¾¿æµ‹è¯•)ã€‚

- å¦‚æœå¼€å¯ï¼Œè¯·ç¡®ä¿æ³¨å†Œåå»é‚®ç®±æŸ¥æ”¶ç¡®è®¤ä¿¡ã€‚

### 4. é…ç½® URL Configuration

Supabase ä¸ºäº†å®‰å…¨ï¼Œåªå…è®¸é‡å®šå‘åˆ°ç™½åå•å†…çš„åŸŸåã€‚

ä¿®æ”¹ Site URLï¼š

- å°†å…¶æ”¹ä¸ºä½ çš„ç”Ÿäº§åŸŸåï¼šhttps://ä½ çš„åŸŸå.com

æ£€æŸ¥ Redirect URLsï¼š

- ç¡®ä¿åˆ—è¡¨ä¸­åŒ…å«ä½ çš„å›è°ƒåœ°å€ï¼šhttps://ä½ çš„åŸŸå.com/auth/callback

å»ºè®®ï¼šä½ å¯ä»¥ä¿ç•™ http://localhost:3000/** ä»¥ä¾¿æœ¬åœ°å¼€å‘æµ‹è¯•ã€‚

ç‚¹å‡» Saveã€‚

### 5. ç»™äºˆè‡ªå·±é‚®ç®±ç®¡ç†å‘˜æƒé™
```SQL
-- å°†ç‰¹å®šé‚®ç®±çš„ç”¨æˆ·æå‡ä¸ºç®¡ç†å‘˜
UPDATE public.profiles
SET role = 'admin'
WHERE email = 'ä½ çš„é‚®ç®±åœ°å€@example.com';

-- å¼€å¯ RLS
alter table public.profiles enable row level security;
```

### 6. è·å–Secret key

- æ‰“å¼€ Supabase Dashboard
- è¿›å…¥ Settings â†’ API
- æ‰¾åˆ° Project API keys éƒ¨åˆ†
- å¤åˆ¶ Secret keysæˆ–service_role key
- æ·»åŠ åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ .env.local æ–‡ä»¶

## ğŸ“¦ éƒ¨ç½²æŒ‡å— (Vercel)

1. **æ¨é€åˆ° GitHub**: å°†ä½ çš„ä»£ç æäº¤åˆ° GitHub ä»“åº“ã€‚

2. **å¯¼å…¥åˆ° Vercel**:

- åœ¨ Vercel Dashboard ç‚¹å‡» "Add New..." -> "Project"ã€‚

- é€‰æ‹©ä½ çš„ GitHub ä»“åº“ã€‚

3. **é…ç½®ç¯å¢ƒå˜é‡**: åœ¨ Vercel çš„éƒ¨ç½²é…ç½®é¡µé¢çš„ Environment Variables åŒºåŸŸï¼Œæ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

- `NEXT_PUBLIC_SUPABASE_URL`: (åŒæœ¬åœ°)

- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: (åŒæœ¬åœ°)

4. **ç‚¹å‡» Deploy**: ç­‰å¾…æ„å»ºå®Œæˆå³å¯ã€‚

## ğŸ“‚ç›®å½•ç»“æ„
```Plaintext
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/            # ä¾›å‰ç«¯è°ƒç”¨çš„ API è·¯ç”±
â”‚   â”œâ”€â”€ dashboard/      # åå°ç®¡ç†é¡µé¢ (å—ä¿æŠ¤)
â”‚   â”œâ”€â”€ login/          # ç™»å½•/æ³¨å†Œé¡µé¢
â”‚   â”œâ”€â”€ [slug]/         # æ ¸å¿ƒè·³è½¬é€»è¾‘ (Serverless Function)
â”‚   â”œâ”€â”€ layout.tsx      # æ ¹å¸ƒå±€
â”‚   â””â”€â”€ page.tsx        # é¦–é¡µ
â”œâ”€â”€ components/         # UI ç»„ä»¶ (shadcn, copy-button ç­‰)
â”œâ”€â”€ lib/                # å·¥å…·åº“
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ supabase/       # Supabase å®¢æˆ·ç«¯å°è£… (Server/Client/Middleware)
â””â”€â”€ middleware.ts       # è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶
```